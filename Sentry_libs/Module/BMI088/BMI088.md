# 食用方法
配置：
打开SPI1
首先你需要定义一个BMI088实例  
Bmi088Instance_s *bmi088_test; // 示例
然后设置其Conifg（主要是子实例的config）  
再调用注册函数
```
Bmi088InitConfig_s bmi088_config = {
    .spi_acc_config = {
        .spi_handle = &hspi1,                    // SPI句柄
        .GPIOx = GPIOA,                          // 加速度计CS引脚端口
        .cs_pin = GPIO_PIN_4,                    // 加速度计CS引脚
        .spi_work_mode = SPI_BLOCKING_MODE,            // 中断模式
        .spi_module_callback = Bmi088_Callback,  // SPI回调函数
        .id = NULL,                              // 父模块指针（将在注册时设置）
        .tx_len = 8,                             // 发送缓冲区长度
        .rx_len = 8,                             // 接收缓冲区长度
    },
    .spi_gyro_config = {
        .spi_handle = &hspi1,                    // SPI句柄
        .GPIOx = GPIOB,                          // 陀螺仪CS引脚端口
        .cs_pin = GPIO_PIN_0,                    // 陀螺仪CS引脚
        .spi_work_mode = SPI_BLOCKING_MODE,            // 中断模式
        .spi_module_callback = Bmi088_Callback,  // SPI回调函数
        .id = NULL,                              // 父模块指针（将在注册时设置）
        .tx_len = 8,                             // 发送缓冲区长度
        .rx_len = 8,                             // 接收缓冲区长度
    },
    
    // 工作模式配置，就是调试与否。后面再写
    // .cali_mode = BMI088_LOAD_PRE_CALIBRATION_MODE,
    // .work_mode = BMI088_BLOCKING_PERIODIC_MODE,
  };
  
  // 注册BMI088实例
  bmi088_test = Bmi088_Register(&bmi088_config);  
```
之后在任务循环中使用BMI088_Read，就可以了

## BMI088读取流程：
CS1ACC引脚，也就是PA7，对应加速度计。  
CS1GRYO引脚，也就是PA4，对应陀螺仪。  
上电时，陀螺仪处于正常模式，加速度计处于暂停模式。  
向寄存器0x7E 写入值0xB6，加速度计的各个寄存器的值会恢复为默认值，这个叫做软件复位，需要1ms来完成。复位除了软件复位，还有硬件复位,比如上电。每次复位后都要向寄存器0x7D写入值0x04，以便获取加速度计的值.  
暂停模式里加速度计的整个模拟部分关断，不执行数据采集，寄存器的值不更新，但仍然可以读取。向寄存器ACC_PWR_CTRL(即寄存器0x7D)写入值0x04，使加速度计进入正常模式，需要450us，即0.45ms，HAL_Delay()函数最小只能延时1ms，所以我们程序里这里按1ms来延时  
因此初始化大概分成三步：
1. 切换到对应片选引脚  
2. 软件复位   
3. 写入正常模式    
再加上检查Who i am，共4步，陀螺仪还少一步。  
但是我们还需要配置读取频率和低通滤波截止频率，也就是向寄存器中写入配置模式。虽然手册上并没有提到启动需要填入参数，但是实际上不填入参数并不会正常运行。以及中断就绪等引脚，也需要重新定义，否则会出现读取寄存器没有问题但是数据是空的现象。
## BMI088寄存器详解与启动流程

### 加速度计关键寄存器
| 地址 | 寄存器名 | 说明 |
|------|----------|------|
| 0x00 | ACC_CHIP_ID | 芯片ID，读取值应为0x1E |
| 0x02 | ACC_ERR_REG | 错误状态寄存器 |
| 0x03 | ACC_STATUS | 状态寄存器，bit[7]为数据就绪标志 |
| 0x12 | ACC_X_LSB | X轴加速度低字节 |
| 0x13 | ACC_X_MSB | X轴加速度高字节 |
| 0x14 | ACC_Y_LSB | Y轴加速度低字节 |
| 0x15 | ACC_Y_MSB | Y轴加速度高字节 |
| 0x16 | ACC_Z_LSB | Z轴加速度低字节 |
| 0x17 | ACC_Z_MSB | Z轴加速度高字节 |
| 0x22 | ACC_TEMP_MSB | 温度高字节 |
| 0x23 | ACC_TEMP_LSB | 温度低字节 |
| 0x40 | ACC_CONF | 配置寄存器（采样率、带宽等） |
| 0x41 | ACC_RANGE | 量程配置寄存器 |
| 0x53 | INT1_IO_CTRL | INT1引脚配置寄存器 |
| 0x58 | INT_MAP_DATA | 数据就绪中断映射寄存器 |
| 0x7C | ACC_PWR_CONF | 电源配置寄存器 |
| 0x7D | ACC_PWR_CTRL | 电源控制寄存器，写入0x04启用加速度计 |
| 0x7E | ACC_SOFTRESET | 软复位寄存器，写入0xB6执行复位 |

### 陀螺仪关键寄存器
| 地址 | 寄存器名 | 说明 |
|------|----------|------|
| 0x00 | GYRO_CHIP_ID | 芯片ID，读取值应为0x0F |
| 0x02 | GYRO_X_LSB | X轴角速度低字节 |
| 0x03 | GYRO_X_MSB | X轴角速度高字节 |
| 0x04 | GYRO_Y_LSB | Y轴角速度低字节 |
| 0x05 | GYRO_Y_MSB | Y轴角速度高字节 |
| 0x06 | GYRO_Z_LSB | Z轴角速度低字节 |
| 0x07 | GYRO_Z_MSB | Z轴角速度高字节 |
| 0x0A | GYRO_INT_STAT_1 | 中断状态寄存器1 |
| 0x0F | GYRO_RANGE | 量程配置寄存器 |
| 0x10 | GYRO_BANDWIDTH | 带宽配置寄存器 |
| 0x11 | GYRO_LPM1 | 低功耗模式1寄存器 |
| 0x14 | GYRO_SOFTRESET | 软复位寄存器，写入0xB6执行复位 |
| 0x15 | GYRO_INT_CTRL | 中断控制寄存器，写入0x80启用数据就绪中断 |
| 0x16 | INT3_INT4_IO_CONF | INT3/INT4引脚配置寄存器 |
| 0x18 | INT3_INT4_IO_MAP | INT3/INT4引脚功能映射寄存器 |

### 详细启动流程

#### 1. SPI通信初始化
- 配置SPI接口参数
- 设置CS引脚：PA7(加速度计)，PA4(陀螺仪)
- 执行dummy读取以触发I2C到SPI模式切换

#### 2. 加速度计初始化序列
1. **身份验证**：读取0x00寄存器，验证返回值为0x1E
2. **软件复位**：向0x7E写入0xB6，等待1ms复位完成
3. **启用加速度计**：
   - 向0x7D写入0x04，启用加速度计正常模式
   - 向0x7C写入0x00，配置为活跃模式
4. **配置工作参数**：
   - 向0x40写入0xAB，设置800Hz采样率，正常模式
   - 向0x41写入0x01，设置±6g量程
5. **配置数据就绪中断**：
   - 向0x53写入0x08，配置INT1引脚为推挽输出
   - 向0x58写入0x04，映射数据就绪中断到INT1
6. **验证配置**：读回各配置寄存器确认设置正确

#### 3. 陀螺仪初始化序列
1. **身份验证**：读取0x00寄存器，验证返回值为0x0F
2. **软件复位**：向0x14写入0xB6，等待300ms复位完成
3. **配置工作参数**：
   - 向0x0F写入0x00，设置±2000°/s量程
   - 向0x10写入0x81，设置2000Hz采样率，230Hz带宽
   - 向0x11写入0x00，设置正常工作模式
4. **配置数据就绪中断**：
   - 向0x15写入0x80，启用数据就绪中断
   - 向0x16写入0x01，配置INT3引脚为推挽输出
   - 向0x18写入0x01，映射数据就绪中断到INT3
5. **验证配置**：读回配置寄存器确认设置正确

#### 4. 数据读取策略
- **加速度计**：从0x12开始读取6字节获取XYZ轴数据
- **陀螺仪**：从0x00开始读取8字节，先验证CHIP_ID，再提取XYZ轴数据
- **温度**：从0x22读取2字节温度数据
- **数据转换**：使用对应的量程系数将原始数据转换为物理单位

#### 5. 时序要求
- 加速度计复位后延时：≥1ms
- 陀螺仪复位后延时：≥300ms  
- 配置寄存器后延时：≥1ms
- SPI时钟频率：≤10MHz
- 加速度计读取需要1个dummy字节
- 陀螺仪读取数据前需要发送寄存器地址

### 数据就绪中断机制
- 加速度计：每次新数据可用时触发INT1，读取数据后自动清除
- 陀螺仪：每次新数据可用时触发INT3，280-400μs后自动清除
- 可通过轮询状态寄存器或使用硬件中断获取数据就绪信号

